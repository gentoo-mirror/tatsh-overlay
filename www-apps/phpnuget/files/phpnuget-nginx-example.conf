server {
    listen 80;
    index index.php;

    # Allow only local systems
    # allow 192.168.0.0/16;
    # deny all;

    # Security-related
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;

    # Root
    # Review /etc/vhosts/webapp-config if necessary
    # Install with webapp-config -I phpnuget $VERSION
    # This is path where index.php is
    root /var/www/localhost/htdocs/phpnuget;
    index index.php;
    # You can instead directly reference the installed files without using
    # webapp-config, but you must update the path on every update
    # root /usr/share/webapps/phpnuget/5.9/htdocs;

    # API V1
    location ~ ^/api/v1/\$metadata {
        rewrite .* /api/v1/index.php?action=metadata;
    }
    location ~ ^/api/v1/Search\(\) {
        rewrite .* /api/v1/index.php?action=search;
    }
    location ~ ^/api/v1/Search\(\)/\$count {
        rewrite .* /api/v1/index.php?action=search&count=true;
    }
    location ~ ^/api/v1/Packages\(Id='([^/]+)',Version='([^/]+)'\) {
        rewrite (.*)api/v1/Packages\(Id='([^/]+)',Version='([^/]+)'\)$ /api/v1/index.php?action=single&id=$2&version=$3&%1;
    }
    location ~ ^/api/v1/Packages(\(\))?/\$count {
        rewrite .* /api/v1/index.php?action=packages&count=true;
    }
    location ~ ^/api/v1/Packages {
        rewrite .* /api/v1/index.php?action=packages;
    }
    location ~ ^/api/v1/FindPackagesById\(\)/\$count {
        rewrite .* /api/v1/index.php?action=findpackagesbyd&count=true;
    }
    location ~ ^/api/v1/FindPackagesById(\(\))? {
        rewrite .* /api/v1/index.php?action=findpackagesbyd;
    }
    location ~ ^/api/v1/package/([^/]+)/([^/]+) {
        rewrite (.*)api/v1/package/([^/]+)/([^/]+)$ /api/?id=$2&version=$3&%1;
    }
    # API V2
    location ~ ^/Packages\(\) {
        rewrite .* /api/v2/index.php?action=packages;
    }
    location ~ ^/FindPackagesById(\(\))? {
        rewrite .* /api/v2/index.php?action=findpackagesbyd;
    }
    location ~ ^/api/v2/\$metadata {
        rewrite .* /api/v2/index.php?action=metadata;
    }
    location ~ ^/api/v2/Search\(\)/\$count {
        rewrite .* /api/v2/index.php?action=search&count=true;
    }
    location ~ ^/api/v2/Packages\(Id='([^/]+)',Version='([^/]+)'\) {
        rewrite (.*)api/v2/Packages\(Id='([^/]+)',Version='([^/]+)'\)$ /api/v2/index.php?action=single&id=$2&version=$3&%1;
    }
    location ~ ^/api/v2/Search\(\) {
        rewrite .* /api/v2/index.php?action=search;
    }
    location ~ ^/api/v2/Packages(\(\))?/\$count {
        rewrite .* /api/v2/index.php?action=packages&count=true;
    }
    location ~ ^/api/v2/Packages(\(\))? {
        rewrite .* /api/v2/index.php?action=packages;
    }
    location ~ ^/api/v2/GetUpdates\(\)/\$count {
        rewrite .* /api/v2/index.php?action=getupdates&count=true;
    }
    location ~ ^/api/v2/GetUpdates\(\) {
        rewrite .* /api/v2/index.php?action=getupdates;
    }
    location ~ ^/api/v2/FindPackagesById(\(\))?/\$count {
        rewrite .* /api/v2/index.php?action=findpackagesbyd&count=true;
    }
    location ~ ^/api/v2/FindPackagesById(\(\))? {
        rewrite .* /api/v2/index.php?action=findpackagesbyd;
    }
    location ~ ^/api/v2/package/([^/]+)/([^/]+) {
        rewrite (.*)api/v2/package/([^/]+)/([^/]+)$ /api/?id=$2&version=$3&%1;
    }
    location ~ ^/api/v2/package {
        rewrite .* /upload/;
    }
    location ~ ^/api/v2/\$batch {
        rewrite .* /api/v2/batch.php;
    }
    # API V3
    location ~ ^/api/v3/index.json {
        rewrite .* /api/v3/index.php?action=resources;
    }
    location ~ ^/api/v3/search/service/fields {
        rewrite .* /api/v3/index.php?action=searchFields;
    }
    location ~ ^/api/v3/search/service/query {
        rewrite .* /api/v3/index.php?action=searchQuery;
    }
    location ~ ^/api/v3/search/service/diag {
        rewrite .* /api/v3/index.php?action=searchDiag;
    }
    location ~ ^/api/v3/search/service {
        rewrite .* /api/v3/index.php?action=searchResources;
    }
    location ~ ^/api/v3/search {
        rewrite .* /api/v3/index.php?action=searchService;
    }
    location ~ ^/api/v3/registration/([^/]+)/([^/]+).json {
        rewrite (.*)api/v3/package/([^/]+)/([^/]+)$  /api/v3/index.php?action=package&id=$2&version=$3;
    }
    location ~ ^/api/v3/registration/([^/]+)/index.json {
        rewrite (.*)api/v3/package/([^/]+)/([^/]+)$  /api/v3/index.php?action=packages&id=$2;
    }

    location ~ [^/]\.php(/|$) {
        fastcgi_split_path_info ^(.+?\.php)(/.*)$;
        if (!-f $document_root$fastcgi_script_name) {
            return 404;
        }
        include       fastcgi_params;
        fastcgi_pass  unix:/run/pihole-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        # Mitigate https://httpoxy.org/ vulnerabilities
        fastcgi_param HTTP_PROXY "";
    }

    location ~* \.(svn|git|patch|htaccess|log|inc|pl|po|sh|ini|sql)$ {
        deny all;
    }
}
