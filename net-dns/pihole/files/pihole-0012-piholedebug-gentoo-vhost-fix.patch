From 8d816bd369ff93bcaf2e90b34f2f7f846c4e7013 Mon Sep 17 00:00:00 2001
From: Andrew Udvare <audvare@gmail.com>
Date: Fri, 14 Jan 2022 18:21:09 -0500
Subject: [PATCH 12/12] piholeDebug Gentoo/vhost fixes

---
 advanced/Scripts/piholeDebug.sh | 81 +++++++++++++++++++--------------
 advanced/Scripts/updatecheck.sh |  2 +-
 2 files changed, 48 insertions(+), 35 deletions(-)

diff --git a/advanced/Scripts/piholeDebug.sh b/advanced/Scripts/piholeDebug.sh
index 9dc9a90e..9335af31 100755
--- a/advanced/Scripts/piholeDebug.sh
+++ b/advanced/Scripts/piholeDebug.sh
@@ -22,9 +22,13 @@ set -o pipefail
 ######## GLOBAL VARS ########
 # These variables would normally be next to the other files
 # but we need them to be first in order to get the colors needed for the script output
-PIHOLE_SCRIPTS_DIRECTORY="@EPREFIX@/usr/@LIBDIR@/pihole"
 PIHOLE_COLTABLE_FILE="@EPREFIX@/usr/@LIBDIR@/pihole/COL_TABLE"

+VHOST_SERVER=lighttpd
+if [ -f /etc/vhosts/webapp-config ]; then
+    VHOST_SERVER=$(grep -F vhost_server= /etc/vhosts/webapp-config | head -n1 | cut '-d"' -f2)
+fi
+
 # These provide the colors we need for making the log more readable
 if [[ -f ${PIHOLE_COLTABLE_FILE} ]]; then
     source ${PIHOLE_COLTABLE_FILE}
@@ -44,13 +48,11 @@ fi
 OBFUSCATED_PLACEHOLDER="<DOMAIN OBFUSCATED>"

 # FAQ URLs for use in showing the debug log
-FAQ_UPDATE_PI_HOLE="${COL_CYAN}https://discourse.pi-hole.net/t/how-do-i-update-pi-hole/249${COL_NC}"
 FAQ_CHECKOUT_COMMAND="${COL_CYAN}https://discourse.pi-hole.net/t/the-pihole-command-with-examples/738#checkout${COL_NC}"
 FAQ_HARDWARE_REQUIREMENTS="${COL_CYAN}https://docs.pi-hole.net/main/prerequisites/${COL_NC}"
 FAQ_HARDWARE_REQUIREMENTS_PORTS="${COL_CYAN}https://docs.pi-hole.net/main/prerequisites/#ports${COL_NC}"
 FAQ_HARDWARE_REQUIREMENTS_FIREWALLD="${COL_CYAN}https://docs.pi-hole.net/main/prerequisites/#firewalld${COL_NC}"
 FAQ_GATEWAY="${COL_CYAN}https://discourse.pi-hole.net/t/why-is-a-default-gateway-important-for-pi-hole/3546${COL_NC}"
-FAQ_ULA="${COL_CYAN}https://discourse.pi-hole.net/t/use-ipv6-ula-addresses-for-pi-hole/2127${COL_NC}"
 FAQ_FTL_COMPATIBILITY="${COL_CYAN}https://github.com/pi-hole/FTL#compatibility-list${COL_NC}"
 FAQ_BAD_ADDRESS="${COL_CYAN}https://discourse.pi-hole.net/t/why-do-i-see-bad-address-at-in-pihole-log/3972${COL_NC}"

@@ -59,18 +61,14 @@ FORUMS_URL="${COL_CYAN}https://discourse.pi-hole.net${COL_NC}"

 # Directories required by Pi-hole
 # https://discourse.pi-hole.net/t/what-files-does-pi-hole-use/1684
-CORE_GIT_DIRECTORY="@EPREFIX@/usr/@LIBDIR@/pihole"
 CRON_D_DIRECTORY="@EPREFIX@/etc/cron.d"
 DNSMASQ_D_DIRECTORY="@EPREFIX@/etc/pihole/dnsmasq.d"
 PIHOLE_DIRECTORY="@EPREFIX@/var/lib/pihole"
-PIHOLE_SCRIPTS_DIRECTORY="@EPREFIX@/usr/@LIBDIR@/pihole"
 BIN_DIRECTORY="@EPREFIX@/usr/bin"
 RUN_DIRECTORY="@EPREFIX@/run"
 LOG_DIRECTORY="@EPREFIX@/var/log"
-WEB_SERVER_LOG_DIRECTORY="${LOG_DIRECTORY}/lighttpd"
+WEB_SERVER_LOG_DIRECTORY="${LOG_DIRECTORY}/${VHOST_SERVER}"
 WEB_SERVER_CONFIG_DIRECTORY="@EPREFIX@/etc/lighttpd"
-HTML_DIRECTORY="@EPREFIX@/var/www/localhost/htdocs"
-WEB_GIT_DIRECTORY="${HTML_DIRECTORY}/pihole-admin"
 #BLOCK_PAGE_DIRECTORY="${HTML_DIRECTORY}/pihole"
 SHM_DIRECTORY="/dev/shm"
 ETC="/etc"
@@ -142,7 +140,7 @@ DNSMASQ_CONF="${ETC}/dnsmasq.conf"
 #SUPPORTED_OS=("Raspbian" "Ubuntu" "Fedora" "Debian" "CentOS")

 # Store Pi-hole's processes in an array for easy use and parsing
-PIHOLE_PROCESSES=( "lighttpd" "pihole-FTL" )
+PIHOLE_PROCESSES=( "pihole-FTL" "$VHOST_SERVER" )

 # Store the required directories in an array so it can be parsed through
 #REQUIRED_DIRECTORIES=("${CORE_GIT_DIRECTORY}"
@@ -183,7 +181,9 @@ REQUIRED_FILES=("${PIHOLE_CRON_FILE}"
 "${DNSMASQ_CONF}"
 "${PIHOLE_CUSTOM_HOSTS_FILE}")

-DISCLAIMER="This process collects information from your Pi-hole, and optionally uploads it to a unique and random directory on tricorder.pi-hole.net.
+DISCLAIMER="tatsh-overlay message: The following output may differ significantly from a standard Pi-hole installation's. Any issues should be posted WITHOUT this log to https://github.com/Tatsh/tatsh-overlay/issues before sending an issue upstream. You will then be advised if upstream is relevant for the issue. If a log is necessary, it will be requested.
+
+This process collects information from your Pi-hole, and optionally uploads it to a unique and random directory on tricorder.pi-hole.net.

 The intent of this script is to allow users to self-diagnose their installations.  This is accomplished by running tests against our software and providing the user with links to FAQ articles when a problem is detected.  Since we are a small team and Pi-hole has been growing steadily, it is our hope that this will help us spend more time on development.

@@ -299,7 +299,7 @@ compare_local_version_to_git_version() {
             else
                 # echo the current version in yellow, signifying it's something to take a look at, but not a critical error
                 # Also add a URL to an FAQ
-                log_write "${INFO} ${pihole_component}: ${COL_YELLOW}${remote_version:-Untagged}${COL_NC} (${FAQ_UPDATE_PI_HOLE})"
+                log_write "${INFO} ${pihole_component}: ${COL_YELLOW}${remote_version:-Untagged}${COL_NC}"
             fi

             # Print the repo upstreams
@@ -360,16 +360,12 @@ check_ftl_version() {
         log_write "${TICK} ${ftl_name}: ${COL_GREEN}${FTL_VERSION}${COL_NC}"
     else
         # If not, show it in yellow, signifying there is an update
-        log_write "${TICK} ${ftl_name}: ${COL_YELLOW}${FTL_VERSION}${COL_NC} (${FAQ_UPDATE_PI_HOLE})"
+        log_write "${TICK} ${ftl_name}: ${COL_YELLOW}${FTL_VERSION}${COL_NC}"
     fi
 }

 # Checks the core version of the Pi-hole codebase
 check_component_versions() {
-    # Check the Web version, branch, and commit
-    compare_local_version_to_git_version "${CORE_GIT_DIRECTORY}" "Core"
-    # Check the Web version, branch, and commit
-    compare_local_version_to_git_version "${WEB_GIT_DIRECTORY}" "Web"
     # Check the FTL version
     check_ftl_version
 }
@@ -386,8 +382,12 @@ get_program_version() {
                     ;;
         "php") program_version="$(${program_name} -v 2> /dev/null | head -n1 | cut -d '-' -f1 | cut -d ' ' -f2)"
                 ;;
+        "nginx") program_version="$(${program_name} -v 2>&1 | head -n1 | cut -d/ -f2)"
+                ;;
+        apache*) program_version="$(apache2 -v 2> /dev/null | grep -F version: | cut -d/ -f2 | cut '-d ' -f1)"
+                ;;
         # If a match is not found, show an error
-        *) echo "Unrecognized program";
+        *) echo "Unrecognized program '${program_name}'";
     esac
     # If the program does not have a version (the variable is empty)
     if [[ -z "${program_version}" ]]; then
@@ -403,7 +403,7 @@ get_program_version() {
 # and their versions, using the functions above.
 check_critical_program_versions() {
     # Use the function created earlier and bundle them into one function that checks all the version numbers
-    get_program_version "lighttpd"
+    get_program_version "$VHOST_SERVER"
     get_program_version "php"
 }

@@ -422,6 +422,7 @@ os_check() {

     # Extract dig response
     response="${cmdResult%%$'\n'*}"
+    response="${response} Gentoo=1"

     IFS=" " read -r -a supportedOS < <(echo "${response}" | tr -d '"')
     for distro_and_versions in "${supportedOS[@]}"
@@ -434,7 +435,7 @@ os_check() {
             IFS="," read -r -a supportedVer <<<"${versions_part}"
             for version in "${supportedVer[@]}"
             do
-                if [[ "${detected_version}" =~ $version ]]; then
+                if [[ "${detected_version:-1}" =~ $version ]]; then
                     valid_version=true
                     break
                 fi
@@ -450,9 +451,9 @@ os_check() {
         log_write "${TICK} Distro:  ${COL_GREEN}${detected_os^}${COL_NC}"

         if [ "$valid_version" = true ]; then
-            log_write "${TICK} Version: ${COL_GREEN}${detected_version}${COL_NC}"
+            log_write "${TICK} Version: ${COL_GREEN}${detected_version:-1}${COL_NC}"
         else
-            log_write "${CROSS} Version: ${COL_RED}${detected_version}${COL_NC}"
+            log_write "${CROSS} Version: ${COL_RED}${detected_version:-1}${COL_NC}"
             log_write "${CROSS} Error: ${COL_RED}${detected_os^} is supported but version ${detected_version} is currently unsupported (${FAQ_HARDWARE_REQUIREMENTS})${COL_NC}"
         fi
     else
@@ -743,7 +744,7 @@ check_required_ports() {
     # Since Pi-hole needs 53, 80, and 4711, check what they are being used by
     # so we can detect any issues
     local resolver="pihole-FTL"
-    local web_server="lighttpd"
+    local web_server="${VHOST_SERVER}"
     local ftl="pihole-FTL"
     # Create an array for these ports in use
     ports_in_use=()
@@ -792,6 +793,12 @@ check_networking() {
 }

 check_x_headers() {
+    if emerge --search www-apps/pihole-admin-lte | grep -F installed | grep -Fq 'Not Installed'; then
+        return
+    fi
+    if [ -f "@EPREFIX@/etc/pihole/debug-vars" ]; then
+        source "@EPREFIX@/etc/pihole/debug-vars"
+    fi
     # The X-Headers allow us to determine from the command line if the Web
     # lighttpd.conf has a directive to show "X-Pi-hole: A black hole for Internet advertisements."
     # in the header of any Pi-holed domain
@@ -801,31 +808,37 @@ check_x_headers() {
     echo_current_diagnostic "Dashboard and block page"
     # Use curl -I to get the header and parse out just the X-Pi-hole one
     local block_page
-    block_page=$(curl -Is localhost | awk '/X-Pi-hole/' | tr -d '\r')
+    if [ -n "${BLOCK_PAGE_HOST}" ]; then
+        block_page=$(curl -Is "${BLOCK_PAGE_HOST}" | awk '/X-Pi-hole/' | tr -d '\r')
+    fi
     # Do it for the dashboard as well, as the header is different than above
     local dashboard
-    dashboard=$(curl -Is localhost/admin/ | awk '/X-Pi-hole/' | tr -d '\r')
+    dashboard=$(curl -Is "${DASHBOARD_HOST}/admin/" | awk '/X-Pi-hole/' | tr -d '\r')
     # Store what the X-Header should be in variables for comparison later
     local block_page_working
     block_page_working="X-Pi-hole: A black hole for Internet advertisements."
     local dashboard_working
     dashboard_working="X-Pi-hole: The Pi-hole Web interface is working!"
     local full_curl_output_block_page
-    full_curl_output_block_page="$(curl -Is localhost)"
+    full_curl_output_block_page="$(curl -Is "${BLOCK_PAGE_HOST}")"
     local full_curl_output_dashboard
-    full_curl_output_dashboard="$(curl -Is localhost/admin/)"
+    full_curl_output_dashboard="$(curl -Is "${DASHBOARD_HOST}/admin/")"
     # If the X-header found by curl matches what is should be,
-    if [[ $block_page == "$block_page_working" ]]; then
+    if [[ ${block_page,,} == "${block_page_working,,}" ]]; then
         # display a success message
         log_write "$TICK Block page X-Header: ${COL_GREEN}${block_page}${COL_NC}"
     else
-        # Otherwise, show an error
-        log_write "$CROSS Block page X-Header: ${COL_RED}X-Header does not match or could not be retrieved.${COL_NC}"
-        log_write "${COL_RED}${full_curl_output_block_page}${COL_NC}"
+        if [ -z "$BLOCK_PAGE_HOST" ]; then
+            log_write "${INFO} Block page host is not specified. Assuming it is not used."
+        else
+            # Otherwise, show an error
+            log_write "$CROSS Block page X-Header: ${COL_RED}X-Header does not match or could not be retrieved.${COL_NC}"
+            log_write "${COL_RED}${full_curl_output_block_page}${COL_NC}"
+        fi
     fi

     # Same logic applies to the dashboard as above, if the X-Header matches what a working system should have,
-    if [[ $dashboard == "$dashboard_working" ]]; then
+    if [[ ${dashboard,,} == "${dashboard_working,,}" ]]; then
         # then we can show a success
         log_write "$TICK Web interface X-Header: ${COL_GREEN}${dashboard}${COL_NC}"
     else
@@ -1139,9 +1152,9 @@ show_content_of_pihole_files() {
     # Show the content of the files in each of Pi-hole's folders
     show_content_of_files_in_dir "${PIHOLE_DIRECTORY}"
     show_content_of_files_in_dir "${DNSMASQ_D_DIRECTORY}"
-    show_content_of_files_in_dir "${WEB_SERVER_CONFIG_DIRECTORY}"
-    show_content_of_files_in_dir "${CRON_D_DIRECTORY}"
-    show_content_of_files_in_dir "${WEB_SERVER_LOG_DIRECTORY}"
+    [ -d "${WEB_SERVER_CONFIG_DIRECTORY}" ] && show_content_of_files_in_dir "${WEB_SERVER_CONFIG_DIRECTORY}"
+    [ -d "${CRON_D_DIRECTORY}" ] && show_content_of_files_in_dir "${CRON_D_DIRECTORY}"
+    [ -d "${WEB_SERVER_LOG_DIRECTORY}" ] && show_content_of_files_in_dir "${WEB_SERVER_LOG_DIRECTORY}"
     show_content_of_files_in_dir "${LOG_DIRECTORY}"
     show_content_of_files_in_dir "${SHM_DIRECTORY}"
     show_content_of_files_in_dir "${ETC}"
--
2.34.1

